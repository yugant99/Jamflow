# ðŸŽµ Jamflow Database Integration Guide

## Overview
This guide explains how to integrate with the enhanced Jamflow API to detect, parse, and store Strudel code generated by the AI system.

## ðŸ” **Code Detection System**

The API now provides comprehensive metadata about generated responses through:

### 1. **Console Logs**
Every API response logs detailed analysis:

```javascript
console.log('ðŸŽµ JAMFLOW RESPONSE ANALYSIS:', {
  type: 'music' | 'conversation',           // Response type
  hasCode: boolean,                         // Contains Strudel code
  codeBlocks: number,                       // Number of code blocks
  confidence: number,                       // Confidence score (0-100+)
  tempo: number | undefined,                // BPM if detected
  instruments: string[],                    // Detected instruments
  patterns: number,                         // Number of sound patterns
  timestamp: string,                        // ISO timestamp
  userQuery: string                         // Original user question
})
```

### 2. **HTTP Headers**
Response headers provide quick metadata access:

```
X-Jamflow-Type: music | conversation
X-Jamflow-Has-Code: true | false
X-Jamflow-Confidence: 0-100+
X-Jamflow-Code-Blocks: number
X-Jamflow-Error: true (only if error)
```

## ðŸŽ¯ **Strudel Code Detection Patterns**

The system detects Strudel code using weighted patterns:

### High-Weight Patterns (10 points):
- `setcpm(120)` - Tempo setting
- `sound("bd sd hh")` - Sound patterns

### Medium-Weight Patterns (8-9 points):
- `note("c3 e3")` - Note patterns
- `stack(...)` - Layering function
- `$: sound(...)` - Track assignment

### Low-Weight Patterns (5-7 points):
- `.gain(0.7)` - Volume effects
- `.room(0.5)` - Reverb effects
- `"bd sd hh"` - Drum patterns

**Confidence Threshold**: 15+ points = Valid Strudel code

## ðŸ“Š **Database Schema Recommendations**

### Core Tables:

```sql
-- Main conversations table
CREATE TABLE conversations (
    id UUID PRIMARY KEY,
    user_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Individual messages
CREATE TABLE messages (
    id UUID PRIMARY KEY,
    conversation_id UUID REFERENCES conversations(id),
    role VARCHAR(10) CHECK (role IN ('user', 'assistant')),
    content TEXT NOT NULL,
    type VARCHAR(20) DEFAULT 'conversation', -- 'music' or 'conversation'
    has_code BOOLEAN DEFAULT false,
    confidence_score INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Extracted Strudel code blocks
CREATE TABLE strudel_code (
    id UUID PRIMARY KEY,
    message_id UUID REFERENCES messages(id),
    code_content TEXT NOT NULL,
    tempo INTEGER,
    instruments JSONB, -- Array of instrument names
    patterns JSONB,    -- Array of sound patterns
    effects JSONB,     -- Array of detected effects
    is_runnable BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- User interactions with code
CREATE TABLE code_interactions (
    id UUID PRIMARY KEY,
    strudel_code_id UUID REFERENCES strudel_code(id),
    user_id VARCHAR(255),
    action VARCHAR(50), -- 'played', 'copied', 'shared', 'modified'
    timestamp TIMESTAMP DEFAULT NOW()
);
```

## ðŸ”§ **Integration Code Examples**

### 1. **Intercepting API Responses**

```javascript
// Middleware to capture Jamflow responses
app.use('/api/chat', async (req, res, next) => {
  const originalSend = res.send
  
  res.send = function(data) {
    // Capture response data
    const hasCode = res.get('X-Jamflow-Has-Code') === 'true'
    const type = res.get('X-Jamflow-Type')
    const confidence = parseInt(res.get('X-Jamflow-Confidence') || '0')
    
    if (hasCode && confidence > 15) {
      // Store in database
      storeStrudelResponse({
        content: data,
        type,
        confidence,
        hasCode,
        userId: req.user?.id,
        timestamp: new Date()
      })
    }
    
    return originalSend.call(this, data)
  }
  
  next()
})
```

### 2. **Code Extraction Function**

```javascript
function extractStrudelCode(responseText) {
  const result = {
    codeBlocks: [],
    explanation: '',
    metadata: {
      tempo: null,
      instruments: [],
      patterns: [],
      effects: []
    }
  }
  
  // Extract code blocks
  const codeBlockRegex = /```(?:javascript|js|strudel)?\n?([\s\S]*?)\n?```/g
  let match
  while ((match = codeBlockRegex.exec(responseText)) !== null) {
    result.codeBlocks.push(match[1].trim())
  }
  
  // Extract metadata
  const tempoMatch = responseText.match(/setcpm\s*\(\s*(\d+)\s*\)/)
  if (tempoMatch) {
    result.metadata.tempo = parseInt(tempoMatch[1])
  }
  
  // Extract instruments
  const instrumentMatches = responseText.matchAll(/sound\s*\(\s*["']([^"']+)["']\s*\)/g)
  result.metadata.patterns = [...instrumentMatches].map(m => m[1])
  
  // Extract effects
  const effectPatterns = [
    /\.gain\s*\(\s*([\d.]+)\s*\)/g,
    /\.room\s*\(\s*([\d.]+)\s*\)/g,
    /\.delay\s*\(\s*([\d.]+)\s*\)/g,
    /\.lpf\s*\(\s*(\d+)\s*\)/g
  ]
  
  effectPatterns.forEach(pattern => {
    const matches = [...responseText.matchAll(pattern)]
    result.metadata.effects.push(...matches.map(m => ({
      type: pattern.source.split('\\')[1],
      value: m[1]
    })))
  })
  
  // Remove code blocks from explanation
  result.explanation = responseText.replace(/```[\s\S]*?```/g, '').trim()
  
  return result
}
```

### 3. **Database Storage Function**

```javascript
async function storeStrudelResponse(data) {
  const { content, type, confidence, hasCode, userId, timestamp } = data
  
  try {
    // Store main message
    const messageId = await db.query(`
      INSERT INTO messages (conversation_id, role, content, type, has_code, confidence_score)
      VALUES ($1, 'assistant', $2, $3, $4, $5)
      RETURNING id
    `, [conversationId, content, type, hasCode, confidence])
    
    if (hasCode) {
      const extracted = extractStrudelCode(content)
      
      // Store each code block
      for (const codeBlock of extracted.codeBlocks) {
        await db.query(`
          INSERT INTO strudel_code (message_id, code_content, tempo, instruments, patterns, effects)
          VALUES ($1, $2, $3, $4, $5, $6)
        `, [
          messageId.rows[0].id,
          codeBlock,
          extracted.metadata.tempo,
          JSON.stringify(extracted.metadata.instruments),
          JSON.stringify(extracted.metadata.patterns),
          JSON.stringify(extracted.metadata.effects)
        ])
      }
    }
    
    console.log('âœ… Stored Jamflow response:', { messageId, hasCode, confidence })
    
  } catch (error) {
    console.error('âŒ Database storage error:', error)
  }
}
```

## ðŸŽµ **Code Validation**

### Runnable Code Checklist:
```javascript
function validateStrudelCode(code) {
  const checks = {
    hasTempo: /setcpm\s*\(\s*\d+\s*\)/.test(code),
    hasSounds: /sound\s*\(\s*["'][^"']+["']\s*\)/.test(code),
    hasValidSyntax: !code.includes('pattern1') && !code.includes('placeholder'),
    hasRealDrums: /bd|sd|hh|cr|oh|cp/.test(code),
    properFormat: code.includes(';') || code.includes('\n')
  }
  
  const score = Object.values(checks).filter(Boolean).length
  return {
    isValid: score >= 3,
    score,
    checks
  }
}
```

## ðŸ“ˆ **Analytics Queries**

### Popular Patterns:
```sql
SELECT patterns, COUNT(*) as usage_count
FROM strudel_code
WHERE patterns IS NOT NULL
GROUP BY patterns
ORDER BY usage_count DESC
LIMIT 10;
```

### Tempo Distribution:
```sql
SELECT tempo, COUNT(*) as count
FROM strudel_code
WHERE tempo IS NOT NULL
GROUP BY tempo
ORDER BY count DESC;
```

### User Engagement:
```sql
SELECT 
  action,
  COUNT(*) as total_actions,
  COUNT(DISTINCT user_id) as unique_users
FROM code_interactions
GROUP BY action;
```

## ðŸš€ **Next Steps**

1. **Set up database tables** using the schema above
2. **Implement API middleware** to capture responses
3. **Create extraction functions** for code and metadata
4. **Add analytics dashboard** for monitoring usage
5. **Implement user feedback** system for code quality

## ðŸ”§ **Testing**

Test with these sample queries:
- `"Create a drum pattern at 120 BPM"`
- `"Make jazz music with piano and bass"`
- `"Generate ambient soundscape with effects"`

Expected detection:
- Type: `music`
- Has Code: `true`
- Confidence: `25-60+`
- Tempo: Extracted number
- Patterns: Array of sound patterns

---

**Questions?** Check the console logs during API calls for real-time analysis data! 